{% extends "base.html" %}

{% block title %}Chat - eLearning{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" >
                <h5 class="mb-0">
                    {% if course %}
                        {{ course.code }} - Group Chat
                    {% elif other_user %}
                        Chat with {{ other_user.get_full_name|default:other_user.username }}
                    {% else %}
                        {{ room.name }}
                    {% endif %}
                </h5>
                 <a href="{% url 'chat-room-list' %}" class="btn btn-outline-secondary btn-sm">Back to Chats,</a>
            </div>

            <!-- Message display area -->
            <div class="card-body" id="chat-messages" style="height: 400px; overflow-y: auto;">
                {% for msg in messages %}
                <div class="mb-2 {% if msg.sender == request.user %}text-end{% endif %}">
                    <div class="d-inline-block p-2 rounded {% if msg.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
                        <small class="fw-bold d-block">{{ msg.sender.username }}</small>
                        {{ msg.content }}
                        <small class="d-block text-{% if msg.sender == request.user %}light{% else %}muted{% endif %}">{{ msg.timestamp|time:"H:i" }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Message input -->
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Type a message..." autofocus>
                    <button id="chat-message-submit" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Pass room data to JavaSript -->
{{ room.id|json_script:"room-id" }}
{{ request.user.id|json_script:"user-id" }}
{{ request.user.username|json_script:"username" }}
<!-- Ddetermine if this is a course chat or DM -->
{% if course %}
{{ course.id|json_script:"course-id" }}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // WebSocket chat client
    const roomId = JSON.parse(document.getElementById('room-id').textContent);
    const userId = JSON.parse(document.getElementById('user-id').textContent);
    const username = JSON.parse(document.getElementById('username').textContent);
    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');

    //Determine WebSocket URL based on room type
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    let wsUrl;

    const courseIdElement = document.getElementById('course-id');
    if (courseIdElement) {
        // Course group chat
        const courseId = JSON.parse(courseIdElement.textContent);
        wsUrl = `${wsScheme}://${window.location.host}/ws/chat/course/${courseId}/`;
    } else {
        // Direct message chat
        wsUrl = `${wsScheme}://${window.location.host}/ws/chat/dm/${roomId}/`;
    }

    // Create WebSocket connection
    const chatSocket = new WebSocket(wsUrl);

    chatSocket.onopen = function() {
        console.log('WebSocket connection established.');
    };

    chatSocket.onmessage = function(e) {
        //Handle incoming messages from the server
        const data = JSON.parse(e.data);
        appendMessage(data.sender_username, data.message, data.timestamp, data.sender_id === userId);
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly. Code:', e.code);
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    // Send message when clicking the send button
    submitButton.onclick = function() {
        sendMessage();
    };

    // Send message when pressing Ente r
    messageInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({'message': message}));
            messageInput.value = '';
        }
    }

    function appendMessage(senderName, content, timestamp, isOwn) {
        // Create and append a new message element to the chat display
        const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        const alignClass = isOwn ? 'text-end' : '';
        const bgClass = isOwn ? 'bg-primary text-white' : 'bg-light';
        const timeClass = isOwn ? 'text-light' : 'text-muted';

        const html = `
            <div class="mb-2 ${alignClass}">
                <div class="d-inline-block p-2 rounded ${bgClass}" style="max-width: 70%;">
                    <small class="fw-bold d-block">${senderName}</small>
                    ${content}
                    <small class="d-block ${timeClass}">${time}</small>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', html);
        // Auto-scroll to the latest message
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Scroll to bottom on page load
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>
{% endblock %}
