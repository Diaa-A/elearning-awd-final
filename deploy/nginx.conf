# Nginx configuration for the eLearning platform.
#
# Serves as a reverse proxy for both HTTP (Gunicorn) and WebSocket (Daphne)
# traffic, handles static/media file serving, and enforces SSL termination.
#
# Place this file at: /etc/nginx/sites-available/elearning
# Then symlink: sudo ln -s /etc/nginx/sites-available/elearning /etc/nginx/sites-enabled/

upstream gunicorn_backend {
    # Gunicorn WSGI server for standard HTTP requests
    server 127.0.0.1:8000;
}

upstream daphne_backend {
    # Daphne ASGI server for WebSocket connections
    server 127.0.0.1:8001;
}

server {
    listen 80;
    server_name _;

    # Redirect all HTTP traffic to HTTPS (uncomment when SSL is configured)
    # return 301 https://$host$request_uri;

    # -- Static and media files served directly by Nginx --
    location /static/ {
        alias /home/ubuntu/elearning/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /home/ubuntu/elearning/media/;
        expires 7d;
    }

    # -- WebSocket connections routed to Daphne --
    location /ws/ {
        proxy_pass http://daphne_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # -- All other HTTP requests routed to Gunicorn --
    location / {
        proxy_pass http://gunicorn_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;

        # File upload size limit (matches Django setting)
        client_max_body_size 50M;
    }
}

# Uncomment the block below when you have SSL certificates configured.
# server {
#     listen 443 ssl;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#
#     # ... copy the location blocks from above ...
# }
